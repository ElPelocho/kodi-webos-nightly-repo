name: Update Kodi Nightly

on:
  schedule:
    - cron: '0 0 * * *'  # cada dÃ­a a medianoche
  workflow_dispatch:

jobs:
  update-nightly:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y wget jq

      - name: Find latest nightly
        run: |
          LATEST=$(curl -s https://ftp.fau.de/xbmc/nightlies/webos/master/ | \
                   grep -oP 'org\.xbmc\.kodi_[0-9]+.*?-master_arm\.ipk' | sort | tail -1)
          echo "LATEST=$LATEST" >> $GITHUB_ENV

      - name: Download latest IPK
        run: wget -O kodi-nightly.ipk "https://ftp.fau.de/xbmc/nightlies/webos/master/$LATEST"

      - name: Compute SHA256 and size
        run: |
          HASH=$(sha256sum kodi-nightly.ipk | awk '{print $1}')
          SIZE=$(stat -c%s kodi-nightly.ipk)
          echo "SHA256=$HASH" >> $GITHUB_ENV
          echo "SIZE=$SIZE" >> $GITHUB_ENV

      - name: Update repo.json
        run: |
          VERSION=$(echo "$LATEST" | sed -E 's/org\.xbmc\.kodi_([0-9]+.*?)-master_arm\.ipk/\1/')
          jq --arg url "https://ftp.fau.de/xbmc/nightlies/webos/master/$LATEST" \
             --arg hash "$SHA256" \
             --arg size "$SIZE" \
             --arg version "$VERSION" \
             '.packages[0].manifest.ipkUrl = $url |
              .packages[0].manifest.ipkHash.sha256 = $hash |
              .packages[0].manifest.ipkSize = ($size | tonumber) |
              .packages[0].manifest.version = $version' repo.json > repo.json.tmp
          mv repo.json.tmp repo.json
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      - name: Commit and push changes
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add repo.json
          git diff --cached --quiet || git commit -m "Update Kodi nightly $VERSION"
          git push https://x-access-token:${{ secrets.PAT_TOKEN }}@github.com/ElPelocho/kodi-webos-nightly-repo.git HEAD:main
