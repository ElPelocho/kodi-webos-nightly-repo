name: Update Kodi Nightly

on:
  schedule:
    - cron: '0 0 * * *' # cada día a medianoche
  workflow_dispatch: # permite ejecución manual

jobs:
  update-nightly:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y wget sha256sum

      - name: Download latest nightly IPK
        run: |
          LATEST=$(curl -s https://mirrors.kodi.tv/nightlies/webos/master/ | grep -oP 'org\.xbmc\.kodi_[0-9]+.*?-master_arm\.ipk' | sort | tail -1)
          wget -O kodi-nightly.ipk "https://mirrors.kodi.tv/nightlies/webos/master/$LATEST"

      - name: Compute SHA256 and size
        run: |
          HASH=$(sha256sum kodi-nightly.ipk | awk '{print $1}')
          SIZE=$(stat -c%s kodi-nightly.ipk)
          echo "SHA256=$HASH" >> $GITHUB_ENV
          echo "SIZE=$SIZE" >> $GITHUB_ENV
          echo "FILE=$LATEST" >> $GITHUB_ENV

      - name: Update repo.json
        run: |
          jq --arg hash "$SHA256" \
             --arg size "$SIZE" \
             --arg file "$FILE" \
             '.packages[0].manifest.ipkUrl = "https://mirrors.kodi.tv/nightlies/webos/master/" + $file |
              .packages[0].manifest.ipkHash.sha256 = $hash |
              .packages[0].manifest.ipkSize = ($size | tonumber) |
              .packages[0].manifest.version = ($file | capture("_(?<ver>[^_]+)-master") | .ver)' repo.json > repo.json.tmp
          mv repo.json.tmp repo.json

      - name: Commit changes
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add repo.json
          git commit -m "Update Kodi nightly $FILE" || echo "No changes"
          git push
